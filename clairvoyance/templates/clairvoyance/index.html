{% load static %}
{% load static i18n %}

<!DOCTYPE html>
<html lang="en">
    <head>
        <title>{{page_title}}</title>
        <!-- Bootstrap core JavaScript -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.3/jquery.mCustomScrollbar.concat.min.js'></script>

        <!--<script src= {% static "vendor/bootstrap/js/bootstrap.bundle.min.js" %} ></script>-->
        <!-- Bootstrap core CSS -->
        <link href= {% static 'vendor/bootstrap/css/bootstrap.min.css' %} rel="stylesheet">
        <link href= {% static 'css/style.css' %} rel="stylesheet">
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
        <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.3/jquery.mCustomScrollbar.min.css'>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.3/jquery.mCustomScrollbar.concat.min.js'></script>
        <!-- Custom styles for this template -->
        <link href={% static 'css/business-casual.min.css' %} rel="stylesheet">
        <!-- Custom fonts for this template -->
        <link href="https://fonts.googleapis.com/css?family=Raleway:100,100i,200,200i,300,300i,400,400i,500,500i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Lora:400,400i,700,700i" rel="stylesheet">
    </head>
    <header class="fixed-top">        
      <nav class="navbar navbar-expand-lg navbar-dark py-lg-4" id="mainNav">
        <div class="container">
          <a class="navbar-brand text-uppercase text-expanded font-weight-bold d-lg-none" href="#">Start Bootstrap</a>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarResponsive">
            <ul class="navbar-nav mx-auto">
              <li class="nav-item px-lg-4">
              <a class="nav-link text-uppercase text-expanded" href="\home">Home</a>
              </li>
              <li class="nav-item active px-lg-4">
              <a class="nav-link text-uppercase text-expanded" href="\clairvoyance">{% trans "Tiragem Tarot" %}</a>
              <span class="sr-only">(current)</span>
              </li>
              <li class="nav-item px-lg-4">
              <a class="nav-link text-uppercase text-expanded" href="\ball8">{% trans "Oracle" %} Ball8</a>
              </li>
              <li class="nav-item px-lg-4">
              <a class="nav-link text-uppercase text-expanded" href="\consultations.html">{% trans "Consultas live" %}</a>
              </li>
              <li class="nav-item px-lg-4">
              <a class="nav-link text-uppercase text-expanded" href="\contact.html">{% trans "Fale comigo" %}</a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
    </header>
    <body class="container">  
      <section class="avenue-messenger col align-self-center">
        <div class="agent-face">
          <div class="half">
          <img class="agent circle" src={% static "img/voyante.jpg" %} alt="voyante"></div>
        </div>
        <div class="chat">
          <div class="chat-title">
            <h1>Senhora T</h1>
            <h2>A vidente Bot</h2>
          </div>
          <div class="messages">
            <div class="messages-content"></div>
          </div>
          <div class="message-box">
            <form action="">
              <script>
                var $messages = $('.messages-content'),
                d, h, m,
                i = 0;
            
                $(window).load(function() {
                  $messages.mCustomScrollbar();
                  firstClairvoyantMessage();
                });
            
            
                function updateScrollbar() {
                  $messages.mCustomScrollbar("update").mCustomScrollbar('scrollTo', 'bottom', {
                    scrollInertia: 10,
                    timeout: 0
                  });
                }
            
                function clairvoyantMessage(message) {
                  $('.message.loading').remove();
                  $('<div class="message new"><figure class="avatar"><img src= "../static/img/voyante.jpg"/></figure>' + message + '</div>').appendTo($('.mCSB_container')).addClass('new');
                  setDate();
                  updateScrollbar();
                }
            
                function setDate(){
                  d = new Date()
                  if (m != d.getMinutes()) {
                    m = d.getMinutes();
                    $('<div class="timestamp">' + d.getHours() + ':' + m + '</div>').appendTo($('.message:last'));
                    $('<div class="checkmark-sent-delivered">&check;</div>').appendTo($('.message:last'));
                    $('<div class="checkmark-read">&check;</div>').appendTo($('.message:last'));
                  }
                }
            
                function insertMessage() {
                msg = $('.message-input').val();
                  if ($.trim(msg) == '') {
                      return false;
                  }
                  escapeHtml(msg);
                  $('<div class="message message-personal">' + msg + '</div>').appendTo($('.mCSB_container')).addClass('new');
                  setDate();
                  $('.message-input').val(null);
                  updateScrollbar();
                  $('<div class="message loading new"><figure class="avatar"><img src="../static/img/voyante.jpg"/></figure><span></span></div>').appendTo($('.mCSB_container'));
                  updateScrollbar();
                  getMessageClairvoyant(msg);
                };
            
                function escapeHtml(msg) {
                  return msg
                  .replace(/&/g, "&amp;")
                  .replace(/</g, "&lt;")
                  .replace(/>/g, "&gt;")
                  .replace(/"/g, "&quot;")
                  .replace(/'/g, "&#039;");
                };
            
                function getMessageClairvoyant(msg) {
                  console.log(msg),
                  $.ajax({
                    type : 'POST',
                    url : "{% url 'clairvoyante' %}",
                    dataType: 'json',
                    data : {
                    csrfmiddlewaretoken: "{{ csrf_token }}",
                    messageInput : msg,
                    },
                    success: function(data) {
                    mapGrandPyMessages(data.messages, data.tag);
                    },
                  });
                };
            
                var id_tags = Array();
                function mapGrandPyMessages(messages,tag) {
                  if(tag==="ups") {
                    grandPyMessage(messages[0]);
                    grandPyMessage(messages[1]);
                    grandPyMessage(messages[2]);
                    grandPyMessage(messages[3]);
                  } else {
                    if(id_tags.includes(tag)){
                    var message_ups = "Petit coquin, a faire des blagues a PaPy.., Cherche plus haut dans la conversation je te l'ai déja trouvé!! Ha les jeuneaux...Revenons a nos moutons.. Que veux-tu que je te trouve encore?"
                    grandPyMessage(message_ups);
                    } else{
                    id_tags.push(tag);
                    grandPyMessage(messages[0]);
                    grandPyMessage(messages[1]);
                    grandPyMessage(messages[2]);
                    $('.message.loading').remove();
                    $('<div class="message new"><figure class="avatar"><img src="../static/img/voyante.jpg" /></figure></div>').appendTo($('.mCSB_container')).addClass('new');
                    setDate();
                    updateScrollbar();
                    grandPyMessage(messages[3]);
                    lastGrandPyMessage();
                    };
                  };
                };
            
                $('.message-submit').click(function() {
                  insertMessage();
                });
            
                $(window).on('keydown', function(e) {
                if (e.which == 13) {
                  insertMessage();
                  return false;
                };
                });

                function firstClairvoyantMessage() {
                  if ($('.message-input').val() != '') {
                    return false;
                  }
                  msg = "Olá, eu sou a Sra. T, sua vidente virtual."+
                  " Proponho esclarecê-lo sobre o seu futuro!"+
                  " Mas, acima de tudo, precisamos nos conhecer."+
                  " Qual é o seu primeiro nome?"
                  clairvoyantMessage(msg);
                };
            
                function lastClairvoyantMessage() {
                  if ($('.message-input').val() != '') {
                    return false;
                  }
                  last = "Voilà petit fou! Une autre question à me soumettre ? Profites je suis de bonne humeur!"
                  clairvoyantMessage(last);
                  };
              
                  $('.button').click(function(){
                  $('.menu .items span').toggleClass('active');
                  $('.menu .button').toggleClass('active');
                });
              </script>
              {% csrf_token %}
              <textarea type="text" class="message-input" placeholder="Pergunta aqui ici..."></textarea>
              <button type="submit" class="message-submit">Enviar</button>
            </form>
          </div>
        </div>
      </section>
    </body>
    <footer class="fixed-bottom">
        <div class="footer text-faded text-center py-5">
            <div class="container">
            <p class="m-0 small">Copyright &copy; Nuno Marcelino 2020</p>
            </div>
        </div>
    </footer>
</html>
